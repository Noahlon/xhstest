<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å¤šå¹³å°è§†é¢‘å¯¹æ¯”ä¸å¸§æ•°è®¡ç®—å·¥å…·</title>
    <style>
        /* é®ç½©ï¼šå¯é˜»æ­¢ç©¿é€ï¼Œè§†è§‰å¼±åŒ–é¡µé¢ */
        #popMask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .08);
            z-index: 9998;
            display: none;
        }

        /* æç¤ºæ¡†ï¼šå³ä¸Šè§’ç»å¯¹å®šä½ */
        #tipBox {
            --w: 220px;
            --h: 44px;
            position: fixed;
            top: 16px;
            right: 16px;
            width: var(--w);
            height: var(--h);
            line-height: var(--h);
            padding: 0 14px;
            background: #ff794d;
            color: #fff;
            font-size: 14px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .15);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity .3s, transform .3s;
            z-index: 9999;
            white-space: nowrap;
        }

        #tipBox.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <style>
        /* ================= å…¨å±€å¸ƒå±€æ ·å¼ ================= */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #333;
            --success-color: #10b981;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Segoe UI, Tahoma, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* å·¦ä¾§è§†é¢‘åŒº */
        .split-left {
            flex: 1;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            padding: 15px;
            min-width: 0;
            /* é˜²æ­¢flexå­é¡¹æº¢å‡º */
            border-right: 1px solid #333;
        }

        /* å³ä¾§è®¡ç®—åŒº */
        .split-right {
            width: 480px;
            /* å›ºå®šå®½åº¦ */
            min-width: 400px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            /* åŸè®¡ç®—å™¨èƒŒæ™¯ */
            overflow-y: auto;
            /* å…è®¸å‚ç›´æ»šåŠ¨ */
            padding: 10px;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        /* ================= å·¦ä¾§è§†é¢‘åŒºæ ·å¼ (åŸé¡µé¢2) ================= */
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            /* ç¨å¾®è°ƒå°æœ€å°å®½åº¦ä»¥é€‚åº”åˆ†æ  */
            gap: 12px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            margin-bottom: 10px;
        }

        .video-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .video-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-replace {
            font-size: 11px;
            background: transparent;
            border: 1px solid #444;
            color: #888;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
        }

        .btn-replace:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            flex: 1;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 150px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        video:focus {
            outline: none;
        }

        .video-wrapper:has(video:focus) {
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .video-wrapper.has-video .upload-overlay {
            opacity: 0;
        }

        .icon-upload {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .controls-area {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 12px 15px;
            border-radius: 12px;
        }

        .timeline-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        #seek {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: #444;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        #seek::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .frame-display {
            font-family: 'Courier New', Courier, monospace;
            background: #000;
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 2px;
            min-width: 100px;
            text-align: center;
            border: 1px solid #333;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .left-tools,
        .right-tools {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: #333;
            color: var(--text-main);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: #444;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .input-group input {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            width: 50px;
            text-align: center;
        }

        .shortcuts {
            font-size: 11px;
            color: #666;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .key {
            background: #2a2a2a;
            padding: 1px 5px;
            border-radius: 3px;
            border: 1px solid #333;
            font-family: monospace;
            color: #aaa;
        }

        input[type="file"] {
            display: none;
        }

        /* ================= å³ä¾§è®¡ç®—åŒºæ ·å¼ (åŸé¡µé¢1) ================= */
        /* è°ƒæ•´ container æ ·å¼ä»¥é€‚åº”å³ä¾§æ  */
        .calc-container {
            background: rgba(255, 255, 255, .95);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .15);
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            /* åº•éƒ¨ç•™ç™½ */
        }

        h1 {
            font-size: 18px;
            color: #1a2a6c;
            text-align: center;
            margin-bottom: 8px;
        }

        .calc-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .calc-controls label {
            font-size: 12px;
            color: #333;
            font-weight: 600;
        }

        .calc-controls select,
        .calc-controls input[type="number"],
        .calc-controls input.case-input {
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
        }

        .fps-select {
            width: 100px;
        }

        .case-select {
            width: 100%;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .custom-fps {
            display: none;
            width: 80px;
        }

        .case-input {
            width: 100%;
        }

        .time-group {
            border: 1px dashed #1a2a6c;
            border-radius: 8px;
            padding: 6px 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }

        .time-group h3 {
            font-size: 14px;
            color: #1a2a6c;
            margin-bottom: 4px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }

        .row label.inline {
            font-size: 11px;
            color: #333;
            min-width: 30px;
        }

        input.timecode {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
            width: 70px;
            text-align: center;
        }

        input.inputfps {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
            width: 80px;
            text-align: center;
        }

        input.inputpath {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
            width: 100%;
            text-align: left;
            margin-top: 2px;
        }

        .result-line {
            font-size: 14px;
            font-weight: 700;
            color: #b21f1f;
            text-align: center;
            margin-top: 2px;
            display: none;
        }

        .calc-text {
            font-family: monospace;
            font-size: 10px;
            color: #555;
            background: #e9ecef;
            border-radius: 6px;
            padding: 4px;
            margin-top: 4px;
            word-break: break-all;
        }

        .copy-btn {
            padding: 3px 6px;
            border-radius: 6px;
            border: 1px solid #bbb;
            background: #fff;
            font-size: 11px;
            cursor: pointer;
            min-width: 50px;
        }

        .copy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* è¿›åº¦æ¡é€‚é… */
        .progress-section {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .progress-container {
            position: relative;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-bar {
            position: absolute;
            height: 4px;
            background-color: #e0e0e0;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            z-index: 1;
            border-radius: 2px;
        }

        .progress {
            position: absolute;
            height: 4px;
            background-color: #4CAF50;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 0%;
            z-index: 2;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .step {
            width: 24px;
            height: 24px;
            background-color: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #999;
            z-index: 3;
            font-size: 10px;
            transition: all 0.4s ease;
        }

        .step.active {
            border-color: #4CAF50;
            background-color: #4CAF50;
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            border-color: #4CAF50;
            background-color: #4CAF50;
            color: white;
        }

        .step.completed::after {
            content: "âœ“";
            font-size: 12px;
        }

        .progress-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .progress-btn {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .progress-btn:hover {
            background-color: #3d8b40;
        }

        .progress-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .progress-status {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            color: #555;
        }

        /* åº•éƒ¨æŒ‰é’®åŒº */
        .action-buttons {
            text-align: center;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            background: #1a2a6c;
        }

        .action-btn:hover {
            opacity: 0.9;
        }

        .clip-btn {
            background: #b21f1f;
        }
    </style>
</head>

<body>
    <!-- å¼¹å‡ºæç¤º -->
    <div id="tipBox">æ“ä½œæˆåŠŸ ğŸ‰</div>
    <div id="popMask"></div>

    <!-- ================= å·¦ä¾§é¢æ¿ï¼šè§†é¢‘æ’­æ”¾å™¨ ================= -->
    <div class="split-left">
        <div class="video-container">
            <!-- æŠ–éŸ³ -->
            <div class="video-card">
                <div class="video-header">
                    <span>æŠ–éŸ³</span>
                    <button class="btn-replace" onclick="triggerUpload(0)">æ›¿æ¢è§†é¢‘</button>
                </div>
                <div class="video-wrapper" onclick="handleWrapperClick(0)">
                    <video class="v" muted tabindex="0"></video>
                    <div class="upload-overlay">
                        <span class="icon-upload">âŠ•</span>
                        <span>ç‚¹å‡»ä¸Šä¼ </span>
                    </div>
                </div>
                <input class="f" type="file" accept="video/*" />
            </div>

            <!-- å°çº¢ä¹¦ -->
            <div class="video-card">
                <div class="video-header">
                    <span>å°çº¢ä¹¦</span>
                    <button class="btn-replace" onclick="triggerUpload(1)">æ›¿æ¢è§†é¢‘</button>
                </div>
                <div class="video-wrapper" onclick="handleWrapperClick(1)">
                    <video class="v" muted tabindex="0"></video>
                    <div class="upload-overlay">
                        <span class="icon-upload">âŠ•</span>
                        <span>ç‚¹å‡»ä¸Šä¼ </span>
                    </div>
                </div>
                <input class="f" type="file" accept="video/*" />
            </div>

            <!-- å¿«æ‰‹ -->
            <div class="video-card">
                <div class="video-header">
                    <span>å¿«æ‰‹</span>
                    <button class="btn-replace" onclick="triggerUpload(2)">æ›¿æ¢è§†é¢‘</button>
                </div>
                <div class="video-wrapper" onclick="handleWrapperClick(2)">
                    <video class="v" muted tabindex="0"></video>
                    <div class="upload-overlay">
                        <span class="icon-upload">âŠ•</span>
                        <span>ç‚¹å‡»ä¸Šä¼ </span>
                    </div>
                </div>
                <input class="f" type="file" accept="video/*" />
            </div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶åŒº -->
        <div class="controls-area">
            <div class="timeline-row">
                <input id="seek" type="range" min="0" max="100" step="0.01" value="0" />
                <div id="frameCode" class="frame-display">00:00:00</div>
            </div>

            <div class="toolbar">
                <div class="left-tools">
                    <div class="input-group">
                        <label>æ’­æ”¾å™¨FPS</label>
                        <input id="fpsInput" type="number" value="30" min="1" />
                    </div>
                    <button id="copyFrameBtn" class="btn btn-primary">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                        å¤åˆ¶å¸§å·
                    </button>
                </div>

                <div class="right-tools shortcuts">
                    <span><span class="key">â†/â†’</span> é€å¸§</span>
                    <span><span class="key">Shift</span>+<span class="key">â†/â†’</span> 10å¸§</span>
                    <span><span class="key">Ctrl</span>+<span class="key">C</span> å¤åˆ¶å¸§å·</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= å³ä¾§é¢æ¿ï¼šè®¡ç®—å™¨ä¸è®°å½•è¡¨ ================= -->
    <div class="split-right">
        <div class="calc-container">
            <!-- è¿›åº¦æ¡éƒ¨åˆ† -->
            <div class="progress-section">
                <div class="progress-container">
                    <div class="progress-bar"></div>
                    <div class="progress" id="progress"></div>
                    <!-- Steps will be generated by JS -->
                </div>
                <div class="progress-status" id="progressStatus">å½“å‰è¿›åº¦: 1/16 - å†·å¯åœºæ™¯</div>

                <div class="progress-controls">
                    <button class="progress-btn" id="prevBtn" disabled>ä¸Šä¸€æ­¥</button>
                    <button class="progress-btn" id="nextBtn">ä¸‹ä¸€æ­¥</button>
                    <button class="progress-btn" id="resetBtn">é‡ç½®</button>
                </div>
            </div>

            <!-- æ§åˆ¶ä¸è¾“å…¥ -->
            <div class="calc-controls">
                <label for="fps">åŸºå‡†FPS</label>
                <select id="fps" class="fps-select">
                    <option value="23.976">23.976</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="29.97">29.97</option>
                    <option value="30" selected>30</option>
                    <option value="50">50</option>
                    <option value="60">60</option>
                    <option value="custom">è‡ªå®šä¹‰</option>Â·
                </select>
                <input type="number" id="custom-fps" class="custom-fps" placeholder="FPS" min="1" step="0.001" />

                <select id="case-select" class="case-select"></select>
                <input class="case-input" id="output-path" placeholder="è¯·è¾“å…¥æµ‹è¯•åœºæ™¯ eg:ä¸Šæµ·12å·çº¿æ—©é«˜å³°" />
            </div>

            <!-- è®¡ç®—ç»„ -->
            <div id="groups"></div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="action-buttons">
                <button id="save-btn" class="action-btn">ä¿å­˜ç»“æœ</button>
                <button id="export-btn" class="action-btn">å¯¼å‡ºExcel</button>
                <button id="clip-btn" class="action-btn clip-btn">å‰ªè¾‘æ‰€æœ‰</button>
                <button id="clip-single-btn" class="action-btn clip-btn">å‰ªè¾‘å•ä¸ª</button>
            </div>
        </div>
    </div>


    <!-- ================= SCRIPTS ================= -->
    <script>
        // å¼¹æ¡†
        function showTip(isSuccess=1, message="") {
            const tip = document.getElementById('tipBox');
            const mask = document.getElementById('popMask');

            if (isSuccess) {
                tip.textContent = message + 'æ“ä½œæˆåŠŸ ğŸ‰';
                tip.style.background = '#ff794d';      // ä¿æŒåŸé…è‰²
            } else {
                tip.textContent = message + 'æ“ä½œå¤±è´¥ âŒ';
                tip.style.background = '#ff4b4b';      // å¤±è´¥è‰²
            }
            // æ˜¾ç¤ºé®ç½© & æç¤º
            mask.style.display = 'block';
            tip.classList.add('show');

            // 2 ç§’åè‡ªåŠ¨æ”¶å›
            setTimeout(() => {
                tip.classList.remove('show');
                mask.style.display = 'none';
            }, 2000);

        }
        /* =========================================
           PART 1: è§†é¢‘æ’­æ”¾å™¨é€»è¾‘ (å·¦ä¾§)
           ========================================= */
        const videos = document.querySelectorAll('.v');
        const inputs = document.querySelectorAll('.f');
        const wrappers = document.querySelectorAll('.video-wrapper');
        const fpsInput = document.getElementById('fpsInput');
        const seekBar = document.getElementById('seek');
        const frameCode = document.getElementById('frameCode');
        const copyFrameBtn = document.getElementById('copyFrameBtn');

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerUpload(index) {
            inputs[index].click();
        }

        // Wrapper ç‚¹å‡»é€»è¾‘
        function handleWrapperClick(index) {
            const v = videos[index];
            if (v.readyState === 0) {
                triggerUpload(index);
            }
        }
        // å¸§æ•°å·®è®¡ç®—å‡½æ•°
        function formatTimecode(startTimecode, endTimecode) {
            if (typeof startTimecode !== 'string' || typeof endTimecode !== 'string' ||
                startTimecode.length !== 6 || endTimecode.length !== 6) {
                throw new Error("æ—¶é—´ç å¿…é¡»æ˜¯6ä½å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸º MMSSFF");
            }

            // è§£æèµ·å§‹æ—¶é—´ç 
            const startMin = parseInt(startTimecode.substring(0, 2), 10);
            const startSec = parseInt(startTimecode.substring(2, 4), 10);
            const startFrame = parseInt(startTimecode.substring(4, 6), 10);

            // è§£æç»“æŸæ—¶é—´ç 
            const endMin = parseInt(endTimecode.substring(0, 2), 10);
            const endSec = parseInt(endTimecode.substring(2, 4), 10);
            const endFrame = parseInt(endTimecode.substring(4, 6), 10);

            // è½¬ä¸ºæ€»å¸§æ•°ï¼ˆ30fpsï¼‰
            const startTotalFrames = (startMin * 60 + startSec) * 30 + startFrame;
            const endTotalFrames = (endMin * 60 + endSec) * 30 + endFrame;

            // è¿”å›å¸§æ•°å·®
            return endTotalFrames - startTotalFrames;
        }

        inputs.forEach((input, i) => {
            input.addEventListener('change', e => {
                const file = e.target.files?.[0];
                if (!file) return;

                // ä¿å­˜æ–‡ä»¶ååˆ° localStorageï¼Œä¾›å³ä¾§è®¡ç®—å™¨ä½¿ç”¨
                const keys = ['douyin', 'xiaohongshu', 'kuaishou'];
                localStorage.setItem(keys[i], file.name);
                console.log('å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:', keys[i], file.name);
                if (i === 0) {
                    douyinPath = clipPathPrefix + "æŠ–éŸ³/" + file.name;
                } else if (i === 1) {
                    xiaohongshuPath = clipPathPrefix + "å°çº¢ä¹¦/" + file.name;
                } else if (i === 2) {
                    kuaishouPath = clipPathPrefix + "/å¿«æ‰‹/" + file.name;
                }
                console.log('æ›´æ–°å‰ªè¾‘è·¯å¾„:', douyinPath, xiaohongshuPath, kuaishouPath);

                // è§¦å‘è®¡ç®—å™¨è·¯å¾„è¾“å…¥æ¡†æ›´æ–° (å¦‚æœå­˜åœ¨)
                const pathInputs = [document.getElementById('path1'), document.getElementById('path2'), document.getElementById('path3')];
                if (pathInputs[i]) {
                    // è¿™é‡Œæ¨¡æ‹Ÿè§¦å‘ä¸€ä¸‹ï¼Œè™½ç„¶è®¡ç®—å™¨é€»è¾‘ä¸»è¦é  input äº‹ä»¶æ›´æ–°å…¨å±€å˜é‡
                    // ä½†æˆ‘ä»¬å¯ä»¥å°è¯•æ›´æ–°æ˜¾ç¤º
                    // pathInputs[i].value å®é™…ä¸Šé€šå¸¸ç”¨äºæ˜¾ç¤ºæˆ–æ‰‹åŠ¨ä¿®æ­£ï¼Œ
                    // ä¸‹é¢ä»£ç ä¸­çš„ douyinPath å˜é‡æ›´æ–°ä¼šåœ¨ PathInput çš„ listener ä¸­å¤„ç†
                    // è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨åˆ·æ–°ä¸€ä¸‹é¡µé¢ä¸Šçš„è·¯å¾„é€»è¾‘
                    // (æ³¨ï¼šåŸé€»è¾‘ä¸»è¦é æ‰‹åŠ¨è¾“å…¥æˆ–é¢„è®¾ï¼Œè¿™é‡Œèåˆåå¯ä»¥æ›´æ™ºèƒ½ï¼Œä½†éµå¾ª"ä¸æ”¹é€»è¾‘"åŸåˆ™ï¼Œä¿æŒåŸæ ·)
                }

                const url = URL.createObjectURL(file);
                videos[i].src = url;
                videos[i].load();
                videos[i].pause();

                wrappers[i].classList.add('has-video');
            });
        });

        videos.forEach(v => {
            v.addEventListener('click', (e) => {
                if (v.readyState > 0) {
                    e.stopPropagation();
                    v.focus();
                }
            });
            v.addEventListener('loadedmetadata', () => {
                if (seekBar.max == 100 || v.duration > seekBar.max) {
                    seekBar.max = v.duration;
                }
            });
            v.addEventListener('timeupdate', updateUI);
        });

        function jump(frames) {
            const mainVideo = Array.from(videos).find(v => v.readyState > 0);
            if (!mainVideo) return;

            const fps = +fpsInput.value || 30;
            const dt = frames / fps;
            const t0 = mainVideo.currentTime + dt;
            const newTime = Math.min(Math.max(0, t0), mainVideo.duration);

            videos.forEach(v => { if (v.readyState > 0) v.currentTime = newTime });
        }

        // é”®ç›˜äº‹ä»¶ç›‘å¬ (ä»…å½“ç„¦ç‚¹ä¸åœ¨è¾“å…¥æ¡†æ—¶)
        document.addEventListener('keydown', async e => {
            // å¦‚æœæ­£åœ¨è¾“å…¥æ–‡å­—ï¼Œä¸è§¦å‘è§†é¢‘å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;

            const mainVideo = Array.from(videos).find(v => v.readyState > 0);

            // å·¦å³é”®æ§åˆ¶å¸§
            if (mainVideo && (e.key === 'ArrowRight' || e.key === 'ArrowLeft')) {
                e.preventDefault();
                const dir = e.key === 'ArrowRight' ? 1 : -1;
                const mult = e.shiftKey ? 10 : 1;
                jump(dir * mult);
            }
            // A D é”®æ§åˆ¶å¸§ (å¤‡ç”¨)
            if (mainVideo && (e.key.toLowerCase() === 'd' || e.key.toLowerCase() === 'a')) {
                e.preventDefault();
                const dir = e.key.toLowerCase() === 'd' ? 1 : -1;
                const mult = e.shiftKey ? 10 : 1;
                jump(dir * mult);
            }
            // ç©ºæ ¼é”®æ’­æ”¾/æš‚åœ
            if (mainVideo && e.key === ' ') {
                e.preventDefault();
                if (mainVideo.paused) {
                    videos.forEach(v => { if (v.readyState > 0) v.play(); });
                } else {
                    videos.forEach(v => { if (v.readyState > 0) v.pause(); });
                }
            }


            // å¤åˆ¶åŠŸèƒ½ (Cmd/Ctrl + C)
            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'c') {
                e.preventDefault();
                const active = document.activeElement;

                // 1. å¤åˆ¶ç”»é¢ (å¦‚æœèšç„¦åœ¨è§†é¢‘ä¸Š)
                if (active && active.tagName === 'VIDEO' && active.readyState > 0 && !e.altKey) {
                    try {
                        const w = active.videoWidth;
                        const h = active.videoHeight;
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(active, 0, 0, w, h);
                        canvas.toBlob(async blob => {
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            // è§†è§‰åé¦ˆ
                            active.parentElement.style.boxShadow = '0 0 0 4px var(--success-color)';
                            setTimeout(() => active.parentElement.style.boxShadow = '', 300);
                        });
                    } catch (err) { }
                    return;
                }

                // 2. å¤åˆ¶å¸§å· (é»˜è®¤)
                await copyFrameCode();
            }
        });

        seekBar.addEventListener('input', () => {
            const t = +seekBar.value;
            videos.forEach(v => { if (v.readyState > 0) v.currentTime = t; });
            updateFrameText(t);
        });

        function updateFrameText(t) {
            const fps = +fpsInput.value || 30;
            const mm = String(Math.floor(t / 60)).padStart(2, '0');
            const ss = String(Math.floor(t % 60)).padStart(2, '0');
            const currentFrame = Math.floor((t % 1) * fps);
            const ff = String(currentFrame).padStart(2, '0').slice(0, 2);
            frameCode.textContent = `${mm}:${ss}:${ff}`;
        }

        function updateUI() {
            const t = this.currentTime;
            if (!isNaN(t)) {
                if (document.activeElement !== seekBar) seekBar.value = t;
                updateFrameText(t);
            }
        }

        async function copyFrameCode() {
            const text = frameCode.textContent.replace(/:/g, ''); // å¤åˆ¶æ ¼å¼ä¸º 000000
            try {
                await navigator.clipboard.writeText(text);
                const originalText = copyFrameBtn.innerHTML;
                copyFrameBtn.innerHTML = `<span style="color:#fff">âœ“ å·²å¤åˆ¶</span>`;
                copyFrameBtn.style.background = 'var(--success-color)';
                setTimeout(() => {
                    copyFrameBtn.innerHTML = originalText;
                    copyFrameBtn.style.background = '';
                }, 1000);
            } catch (err) { console.error(err); }
        }
        copyFrameBtn.addEventListener('click', copyFrameCode);

        /* =========================================
           PART 2: è®¡ç®—å™¨é€»è¾‘ (å³ä¾§)
           ========================================= */

        // å‰ªè¾‘è·¯å¾„å‰ç¼€
        const clipPathPrefix = '/Users/liuqianlong/Desktop/video/ç¬¬äº”è½®æµ‹è¯•/';
        // é»˜è®¤å‰ªè¾‘è·¯å¾„å˜é‡
        let douyinPath = clipPathPrefix + 'æŠ–éŸ³/2025_11_18_18_04_10_IMG_0262.MP4';
        let xiaohongshuPath = clipPathPrefix + 'å°çº¢ä¹¦/2025_11_18_18_04_12_IMG_0311.MP4';
        let kuaishouPath = clipPathPrefix + 'å¿«æ‰‹/2025_11_18_18_04_10_IMG_0263.MP4';

        // å¯¼å‡ºè·¯å¾„
        let outputPath = './output/ä¸Šæµ·12å·çº¿æ—©é«˜å³°/';

        // key å’Œ case æ˜ å°„
        const caseMap = {
            "1": "é¦–åˆ·", "2": "å†·å¯åœºæ™¯1", "3": "å†·å¯åœºæ™¯2", "4": "å†·å¯åœºæ™¯3",
            "5": "é¦–é¡µä¸Šæ‹‰åˆ·æ–°1", "6": "é¦–é¡µä¸Šæ‹‰åˆ·æ–°2", "7": "é¦–é¡µä¸Šæ‹‰åˆ·æ–°3",
            "8": "é¦–é¡µä¸‹æ»‘åˆ·æ–°1", "9": "é¦–é¡µä¸‹æ»‘åˆ·æ–°2", "10": "é¦–é¡µä¸‹æ»‘åˆ·æ–°3",
            "11": "è§†é¢‘å†…æµ1", "12": "è§†é¢‘å†…æµ2", "13": "è§†é¢‘å†…æµ3",
            "14": "æœç´¢1", "15": "æœç´¢2", "16": "ä¸ªäººé¡µ",
            "17": "ä¸Šä¼ å›¾ç‰‡", "18": "ä¸Šä¼ è§†é¢‘"
        };
        const countCase = Object.keys(caseMap).length;
        let datas = {};
        for (const key in caseMap) { datas[key] = {}; }
        let negdata = {
        };
        let resdata = {};

        // åˆå§‹åŒ–caseé€‰æ‹©æ¡†
        const caseSelect = document.getElementById('case-select');
        for (const key in caseMap) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = caseMap[key];
            caseSelect.appendChild(option);
        }

        const progressContainer = document.querySelector('.progress-container');
        // ç”Ÿæˆæ­¥éª¤åœ†ç‚¹
        for (let i = 1; i <= countCase; i++) {
            const step = document.createElement('div');
            step.classList.add('step');
            step.setAttribute('data-step', i);
            step.textContent = i;
            progressContainer.appendChild(step);
        }

        // å­˜å‚¨å¯¼å‡ºæ•°æ®é€»è¾‘
        function setdatas() {

            let douyinfps = '-',
                xiaohongshufps = '-',
                kuaishoufps = '-';

            // éå† 0, 1, 2
            for (let i = 0; i < 3; i++) {
                const index = i + 1; // 1, 2, 3
                const startInput = document.getElementById(`start${index}`).value;
                const endInput = document.getElementById(`end${index}`).value;

                // å¿…é¡»æœ‰å€¼æ‰è®¡ç®—ï¼Œé¿å…ç©ºè¾“å…¥æŠ¥é”™
                if (startInput && endInput) {
                    const fpsDiff = formatTimecode(startInput, endInput);

                    if (i === 0) {
                        douyinfps = fpsDiff;
                    } else if (i === 1) {
                        xiaohongshufps = fpsDiff;
                    } else if (i === 2) {
                        kuaishoufps = fpsDiff;
                    }
                }
                // å¦‚æœä¸ºç©ºï¼Œä¿æŒ '-'
            }

            // fpsä¸ä¸ºæ•°å­—åˆ™ä¸ä¿å­˜
            if (isNaN(douyinfps) || isNaN(xiaohongshufps) || isNaN(kuaishoufps)) {
                console.log('æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•ä¿å­˜');
                return false;
            }

            const key = document.getElementById('case-select').value;

            // â–¼â–¼â–¼ ä¿®æ”¹ç‚¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
            datas[key] = {
                "æŠ–éŸ³": {
                    fps: douyinfps,
                    start_time: document.getElementById('start1').value,
                    end_time: document.getElementById('end1').value,
                    caseName: caseMap[key],
                },
                "å°çº¢ä¹¦": {
                    fps: xiaohongshufps,
                    start_time: document.getElementById('start2').value,
                    end_time: document.getElementById('end2').value,
                    caseName: caseMap[key],
                },
                "å¿«æ‰‹": {
                    fps: kuaishoufps,
                    start_time: document.getElementById('start3').value,
                    end_time: document.getElementById('end3').value,
                    caseName: caseMap[key],
                },
            }; // <--- å¿…é¡»åŠ ä¸Šè¿™ä¸ªåˆ†å·ï¼

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('start1').value = '';
            document.getElementById('end1').value = '';
            document.getElementById('start2').value = '';
            document.getElementById('end2').value = '';
            document.getElementById('start3').value = '';
            document.getElementById('end3').value = '';
            document.getElementById('result1').textContent = 'â€”';
            document.getElementById('result2').textContent = 'â€”';
            document.getElementById('result3').textContent = 'â€”';
            document.getElementById('calc1').textContent = 'ç­‰å¾…è¾“å…¥...';
            document.getElementById('calc2').textContent = 'ç­‰å¾…è¾“å…¥...';
            document.getElementById('calc3').textContent = 'ç­‰å¾…è¾“å…¥...';
            // å¦‚æœæœ‰å•æ¬¡å‰ªè¾‘éœ€æ±‚
            clipSingleVideo(key);
            return true;
        }

        // è¿›åº¦æ¡ç›¸å…³
        let currentStep = 1;
        function initProgressBar() {
            const steps = document.querySelectorAll('.step');
            const progress = document.getElementById('progress');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const resetBtn = document.getElementById('resetBtn');
            const progressStatus = document.getElementById('progressStatus');
            const caseSelect = document.getElementById('case-select');

            function updateProgress() {
                const progressWidth = ((currentStep - 1) / (countCase - 1)) * 100;
                progress.style.width = `${progressWidth}%`;

                steps.forEach((step, index) => {
                    const stepNumber = parseInt(step.getAttribute('data-step'));
                    if (stepNumber < currentStep) {
                        step.classList.add('completed'); step.classList.remove('active');
                    } else if (stepNumber === currentStep) {
                        step.classList.add('active'); step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                progressStatus.textContent = `å½“å‰è¿›åº¦: ${currentStep}/${countCase} - ${caseMap[currentStep]}`;
                prevBtn.disabled = currentStep === 1;
                nextBtn.disabled = currentStep === countCase;
                caseSelect.value = currentStep;

                if (currentStep === countCase) {
                    setdatas();
                    progressStatus.textContent = `å®Œæˆ: ${currentStep}/${countCase} - ${caseMap[currentStep]}`;
                }
            }

            nextBtn.addEventListener('click', function () {
                if (!setdatas()) { alert('è¯·è¾“å…¥æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯'); return; }
                if (currentStep < countCase) { currentStep++; updateProgress(); }
            });

            prevBtn.addEventListener('click', function () {
                if (currentStep > 1) { currentStep--; updateProgress(); }
            });

            resetBtn.addEventListener('click', function () {
                currentStep = 1; updateProgress();
            });

            caseSelect.addEventListener('change', function () {
                currentStep = parseInt(this.value); updateProgress();
            });

            updateProgress();
        }

        document.addEventListener('DOMContentLoaded', function () {
            initProgressBar();

            // æ„å»ºè¾“å…¥ç»„
            const platforms = ['æŠ–éŸ³', 'å°çº¢ä¹¦', 'å¿«æ‰‹'];
            const groups = document.getElementById('groups');
            const fpsSelect = document.getElementById('fps');
            const customFpsInput = document.getElementById('custom-fps');

            platforms.forEach((name, i) => {
                const idx = i + 1;
                const box = document.createElement('div');
                box.className = 'time-group';
                box.innerHTML = `
                      <h3>${name}</h3>
                      <div class="row">
                        <label class="inline">å¼€å§‹:</label>
                        <input class="timecode" id="start${idx}" placeholder="010029" />
                        <label class="inline">ç»“æŸ:</label>
                        <input class="timecode" id="end${idx}" placeholder="010129" />
                        <button class="copy-btn" id="copy${idx}" disabled>å¤åˆ¶</button>

                      </div>
                      <div class="row">
                        <input class="inputfps" id="framecount${idx}" placeholder="è¾“å…¥å¸§æ•°" />
                        <input class="inputpath" id="path${idx}" placeholder="è¯·è¾“å…¥è·¯å¾„" />
                      </div>
                      <div class="result-line" id="resLine${idx}">å¸§æ•°å·®: <span id="result${idx}">â€”</span> å¸§</div>
                      <div class="calc-text" id="calc${idx}">ç­‰å¾…è¾“å…¥...</div>
                    `;
                groups.appendChild(box);
            });
            // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶
            // const inputlist = document.querySelectorAll('input');
            let inputlist = []
            inputlist.push(document.getElementById('start1'));
            inputlist.push(document.getElementById('end1'));
            inputlist.push(document.getElementById('start2'));
            inputlist.push(document.getElementById('end2'));
            inputlist.push(document.getElementById('start3'));
            inputlist.push(document.getElementById('end3'));

            inputlist.forEach(input => {
                input.addEventListener('focus', function () {
                    // è·å–å½“å‰å¸§
                    this.value = document.getElementById('frameCode').textContent.replace(/:/g, '');
                    this.blur();
                });
            });
            // å¸§ç‡äº‹ä»¶
            fpsSelect.addEventListener('change', () => {
                customFpsInput.style.display = fpsSelect.value === 'custom' ? 'inline-block' : 'none';
                calculateAll();
            });
            customFpsInput.addEventListener('input', calculateAll);
            groups.addEventListener('input', calculateAll);

            // å¤åˆ¶äº‹ä»¶
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`copy${i}`);
                btn.addEventListener('click', async () => {
                    const res = document.getElementById(`result${i}`).textContent;
                    try {
                        await navigator.clipboard.writeText(res);
                        btn.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => { btn.textContent = 'å¤åˆ¶'; }, 1000);
                    } catch { }
                });
            }

            function calculateAll() {
                for (let i = 1; i <= 3; i++) calculate(i);
            }

            function calculate(i) {
                const s = document.getElementById(`start${i}`).value.trim();
                const e = document.getElementById(`end${i}`).value.trim();
                const resEl = document.getElementById(`result${i}`);
                const resLine = document.getElementById(`resLine${i}`);
                const calcEl = document.getElementById(`calc${i}`);
                const copyBtn = document.getElementById(`copy${i}`);

                const start = parseTC(s), end = parseTC(e);
                let fps = fpsSelect.value === 'custom' ? parseFloat(customFpsInput.value) : parseFloat(fpsSelect.value);
                if (!(fps > 0)) fps = 0;

                if (start && end && fps > 0) {
                    const startFrames = (start.minutes * 60 + start.seconds) * fps + start.frames;
                    const endFrames = (end.minutes * 60 + end.seconds) * fps + end.frames;
                    const diff = endFrames - startFrames;

                    const timeDiff = { minutes: end.minutes - start.minutes, seconds: end.seconds - start.seconds, frames: end.frames - start.frames };
                    if (timeDiff.frames < 0) { timeDiff.frames += fps; timeDiff.seconds--; }
                    if (timeDiff.seconds < 0) { timeDiff.seconds += 60; timeDiff.minutes--; }

                    const diffRound = Math.round(diff);
                    resEl.textContent = diffRound;
                    resLine.style.display = 'block';
                    calcEl.textContent = `${fmt(start)}â†’${fmt(end)} | ${timeDiff.minutes}åˆ†${timeDiff.seconds}ç§’${Math.round(timeDiff.frames)}å¸§`;
                    copyBtn.disabled = false;
                } else {
                    resEl.textContent = 'â€”';
                    resLine.style.display = 'none';
                    calcEl.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆæ—¶é—´ç ';
                    copyBtn.disabled = true;
                }
            }

            function parseTC(str) {
                if (!str || str.length !== 6) return null;
                const m = parseInt(str.slice(0, 2)), s = parseInt(str.slice(2, 4)), f = parseInt(str.slice(4, 6));
                if (Number.isNaN(m) || Number.isNaN(s) || Number.isNaN(f) || s >= 60 || m < 0 || s < 0 || f < 0) return null;
                return { minutes: m, seconds: s, frames: f };
            }
            function fmt(t) { return `${t.minutes.toString().padStart(2, '0')}:${t.seconds.toString().padStart(2, '0')}:${t.frames.toString().padStart(2, '0')}`; }

            // è·¯å¾„è¾“å…¥æ¡†è”åŠ¨åˆå§‹åŒ–
            const douyinPathInput = document.getElementById('path1');
            const xiaohongshuPathInput = document.getElementById('path2');
            const kuaishouPathInput = document.getElementById('path3');
            const outputPathInput = document.getElementById('output-path');

            // è¯»å– localstorage æ›´æ–°åˆ°è¾“å…¥æ¡†æ˜¾ç¤º
            if (douyinPathInput && localStorage.getItem('douyin')) douyinPathInput.value = localStorage.getItem('douyin');
            if (xiaohongshuPathInput && localStorage.getItem('xiaohongshu')) xiaohongshuPathInput.value = localStorage.getItem('xiaohongshu');
            if (kuaishouPathInput && localStorage.getItem('kuaishou')) kuaishouPathInput.value = localStorage.getItem('kuaishou');

            douyinPathInput?.addEventListener('input', () => {
                douyinPath = clipPathPrefix + douyinPathInput.value + '/' + localStorage.getItem('douyin');
            });
            xiaohongshuPathInput?.addEventListener('input', () => {
                xiaohongshuPath = clipPathPrefix + xiaohongshuPathInput.value + '/' + localStorage.getItem('xiaohongshu');
            });
            kuaishouPathInput?.addEventListener('input', () => {
                kuaishouPath = clipPathPrefix + kuaishouPathInput.value + '/' + localStorage.getItem('kuaishou');
            });
            outputPathInput?.addEventListener('input', () => {
                outputPath = './output/' + outputPathInput.value + '/';
                if (!outputPath.endsWith('/')) outputPath += '/';
            });
        });





        // è¯„åˆ†è§„åˆ™é…ç½®
        const maxScores = {
            "é¦–åˆ·": 30, "å†·å¯åœºæ™¯": 105, "é¦–é¡µä¸Šæ‹‰åˆ·æ–°": 128, "é¦–é¡µä¸‹æ»‘åˆ·æ–°": 139,
            "è§†é¢‘å†…æµ": 105, "æœç´¢": 99, "ä¸ªäººé¡µ": 30, "ä¸Šä¼ å›¾ç‰‡": 10, "ä¸Šä¼ è§†é¢‘": 20,
        };

        // æ‰£åˆ†è®¡ç®—å‡½æ•° (ä¿æŒåŸæ ·)
        function calculatePlatformPenalty(fps) {
            let penalty = 0;
            if (fps <= 50) penalty = 0;
            else if (fps <= 90) penalty = 2;
            else if (fps <= 112) penalty = 4;
            else if (fps <= 200) penalty = 6;
            else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 200) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 30) penalty = 30;
            }
            return penalty;
        }
        // ... (å…¶ä»– penalty å‡½æ•°çœç•¥ï¼Œé€»è¾‘å¤æ‚ä¸”å ç¯‡å¹…ï¼Œå‡è®¾ä¿ç•™åŸé€»è¾‘) ... 
        // ä¸ºèŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œç®€åŒ–å…¶ä»–å‡½æ•°çš„å®ç°å ä½ï¼Œå®é™…åˆå¹¶æ—¶è¯·å°†åŸä»£ç ä¸­çš„ Calculate å‡½æ•°å…¨éƒ¨å¤åˆ¶è¿‡æ¥
        /* 
å†·å¯åœºæ™¯ è®¡ç®—è§„åˆ™
â‰¤50å¸§   ä¸æ‰£æ—¶é•¿
â‰¤90å¸§     -2
â‰¤112å¸§    -4
â‰¤200å¸§   -6
>200å¸§   -8
>200å¸§åæ¯å¤šç­‰å¾…æ»¡ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
æœ€å¤šæ‰£30s   
*/
        function calculatePlatformPenalty(fps) {
            let penalty = 0;
            if (fps <= 50) {
                penalty = 0;
            } else if (fps <= 90) {
                penalty = 2;
            } else if (fps <= 112) {
                penalty = 4;
            } else if (fps <= 200) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 200) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 30) {
                    penalty = 30;
                }

            }
            return penalty;
        }
        /* 
  é¦–é¡µä¸Šæ‹‰åˆ·æ–° è®¡ç®—è§„åˆ™
  â‰¤35å¸§  ä¸æ‰£æ—¶é•¿
  â‰¤55å¸§    -2
  â‰¤112å¸§   -4
  â‰¤150å¸§   -6
  >150å¸§   -8
  >150å¸§æ¯å¤šç­‰å¾…ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
  ç­‰å¾…è¶…è¿‡15sç›´æ¥æ‰£å®Œ
  æœ€å¤šæ‰£35s
  */
        function calculateHomePullPenalty(fps) {

            let penalty = 0;
            if (fps <= 35) {
                penalty = 0;
            } else if (fps <= 55) {
                penalty = 2;
            } else if (fps <= 112) {
                penalty = 4;
            } else if (fps <= 150) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 150) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 30) {
                    penalty = 30;
                }

            }
            return penalty;
        }
        /* 
          é¦–é¡µä¸‹æ‹‰åˆ·æ–° è®¡ç®—è§„åˆ™
            â‰¤35å¸§  ä¸æ‰£æ—¶é•¿
            â‰¤55å¸§    -2
            â‰¤112å¸§   -4
            â‰¤150å¸§   -6
            >150å¸§   -8
            >150å¸§æ¯å¤šç­‰å¾…ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
            ç­‰å¾…è¶…è¿‡15sç›´æ¥æ‰£å®Œ
            æœ€å¤šæ‰£35s
          */
        function calculateHomePushPenalty(fps) {
            let penalty = 0;
            if (fps <= 35) {
                penalty = 0;
            } else if (fps <= 55) {
                penalty = 2;
            } else if (fps <= 112) {
                penalty = 4;
            } else if (fps <= 150) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 150) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 35) {
                    penalty = 35;
                }

            }
            return penalty;
        }


        /* 
               è§†é¢‘å†…æµ è®¡ç®—è§„åˆ™
                 â‰¤30å¸§   ä¸æ‰£æ—¶é•¿
                 â‰¤60å¸§     -2
                 â‰¤100å¸§    -4
                 â‰¤150å¸§   -6
                 >150å¸§   -8
                 >150å¸§åæ¯å¤šç­‰å¾…æ»¡ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
                 æœ€å¤šæ‰£35s
               */
        function calculateVideoStreamPenalty(fps) {
            let penalty = 0;
            if (fps <= 30) {
                penalty = 0;
            } else if (fps <= 60) {
                penalty = 2;
            } else if (fps <= 100) {
                penalty = 4;
            } else if (fps <= 150) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 150) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 35) {
                    penalty = 35;
                }

            }
            return penalty;
        }

        /*
            æœç´¢ è®¡ç®—è§„åˆ™
              å…¨éƒ¨åŠ è½½å®Œæ¯•å¸§ç‡ï¼Œæ‰£é™¤æ—¶é•¿
              â‰¤31å¸§   ä¸æ‰£æ—¶é•¿
              â‰¤45å¸§    -2
              â‰¤120å¸§    -4
              â‰¤180å¸§    -6
              >250å¸§    -8
              >250å¸§æ¯å¤šç­‰å¾…ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œ
              æœ€å¤šæ‰£35s
              ç­‰å¾…è¶…è¿‡15s ç›´æ¥æ‰£å®Œ
            */
        function calculateSearchPenalty(fps) {
            let penalty = 0;
            if (fps <= 31) {
                penalty = 0;
            } else if (fps <= 45) {
                penalty = 2;
            } else if (fps <= 120) {
                penalty = 4;
            } else if (fps <= 180) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 250) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 35) {
                    penalty = 35;
                }

            }
            return penalty;
        }
        /*
          ä¸ªäººé¡µ è®¡ç®—è§„åˆ™
            â‰¤15å¸§   ä¸æ‰£æ—¶é•¿
            â‰¤30å¸§    -2
            â‰¤60å¸§    -4
            â‰¤120å¸§   -6
            >150å¸§   åŠ è½½æˆåŠŸ -8
            >150å¸§æ¯å¤šç­‰å¾…ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
            æœ€å¤šæ‰£30s
          */
        function calculateProfilePenalty(fps) {
            let penalty = 0;
            if (fps <= 15) {
                penalty = 0;
            } else if (fps <= 30) {
                penalty = 2;
            } else if (fps <= 60) {
                penalty = 4;
            } else if (fps <= 120) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 150) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 30) {
                    penalty = 30;
                }

            }
            return penalty;
        }
        /*
          ä¸Šä¼ å›¾ç‰‡ è®¡ç®—è§„åˆ™
            å…¨éƒ¨åŠ è½½å®Œæ¯•å¸§ç‡ï¼Œæ‰£é™¤æ—¶é•¿
            â‰¤30s   ä¸æ‰£æ—¶é•¿
            â‰¤60s   -2
            â‰¤100s  -4
            â‰¤150s  -6
            ä¸Šä¼ å¤±è´¥ï¼Œé‡è¯•æˆåŠŸ    -8
            ä¸Šä¼ å¤±è´¥ï¼Œé‡è¯•å¤±è´¥     -10
            >100å¸§æ¯å¤šç­‰å¾…ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
            æœ€å¤šæ‰£10s
          */
        function calculateImageUploadPenalty(fps) {
            let penalty = 0;
            fps = fps / 30; // è½¬æ¢ä¸ºç§’
            if (fps <= 30) {
                penalty = 0;
            } else if (fps <= 60) {
                penalty = 2;
            } else if (fps <= 100) {
                penalty = 4;
            } else if (fps <= 150) {
                penalty = 6;
            } else {
                penalty = 8;
                let extraSeconds = Math.floor((fps - 150) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 10) {
                    penalty = 10;
                }

            }
            return penalty;
        }
        /*
          ä¸Šä¼ è§†é¢‘ è®¡ç®—è§„åˆ™
            å…¨éƒ¨åŠ è½½å®Œæ¯•å¸§ç‡ï¼Œæ‰£é™¤æ—¶é•¿
            â‰¤â‰¤50s   ä¸æ‰£æ—¶é•¿
            â‰¤100s   -4
            â‰¤200s  -8
            â‰¤300s  -12
            ä¸Šä¼ å¤±è´¥ï¼Œé‡è¯•æˆåŠŸ    -16
            ä¸Šä¼ å¤±è´¥ï¼Œé‡è¯•å¤±è´¥     -20
            >120å¸§æ¯å¤šç­‰å¾…ä¸€ç§’ï¼Œæ‰£æ‰2sæ¶ˆè´¹æ—¶é•¿ï¼Œç›´è‡³æ‰£å®Œã€‚
            æœ€å¤šæ‰£20s
          */
        function calculateVideoUploadPenalty(fps) {
            let penalty = 0;
            fps = fps / 30; // è½¬æ¢ä¸ºç§’
            if (fps <= 50) {
                penalty = 0;
            } else if (fps <= 100) {
                penalty = 4;
            } else if (fps <= 200) {
                penalty = 8;
            } else if (fps <= 300) {
                penalty = 12;
            } else {
                penalty = 16;
                let extraSeconds = Math.floor((fps - 300) / fps);
                penalty += extraSeconds * 2;
                if (penalty > 20) {
                    penalty = 20;
                }

            }
            return penalty;
        }


        // å®Œæ•´è®¡ç®—é€»è¾‘
        // è®¡ç®—é€»è¾‘
        function calculatePenalty() {
            negdata = {
                "æŠ–éŸ³": {},
                "å°çº¢ä¹¦": {},
                "å¿«æ‰‹": {}
            };
            resdata = {
                "æŠ–éŸ³": {},
                "å°çº¢ä¹¦": {},
                "å¿«æ‰‹": {}
            };
            //è®¡ç®—æ‰£åˆ†æ•°æ®
            for (let platform in negdata) {

                negdata[platform]["é¦–åˆ·"] = -calculatePlatformPenalty(datas[1][platform].fps);
                negdata[platform]["å†·å¯åœºæ™¯"] = -calculatePlatformPenalty(datas[2][platform].fps) - calculatePlatformPenalty(datas[3][platform].fps) - calculatePlatformPenalty(datas[4][platform].fps);
                negdata[platform]["é¦–é¡µä¸Šæ‹‰åˆ·æ–°"] = -calculateHomePullPenalty(datas[5][platform].fps) - calculateHomePullPenalty(datas[6][platform].fps) - calculateHomePullPenalty(datas[7][platform].fps);
                negdata[platform]["é¦–é¡µä¸‹æ»‘åˆ·æ–°"] = -calculateHomePushPenalty(datas[8][platform].fps) - calculateHomePushPenalty(datas[9][platform].fps) - calculateHomePushPenalty(datas[10][platform].fps);
                negdata[platform]["è§†é¢‘å†…æµ"] = -calculateVideoStreamPenalty(datas[11][platform].fps) - calculateVideoStreamPenalty(datas[12][platform].fps) - calculateVideoStreamPenalty(datas[13][platform].fps);
                negdata[platform]["æœç´¢"] = -calculateSearchPenalty(datas[14][platform].fps) - calculateSearchPenalty(datas[15][platform].fps);
                negdata[platform]["ä¸ªäººé¡µ"] = -calculateProfilePenalty(datas[16][platform].fps);
                negdata[platform]["ä¸Šä¼ å›¾ç‰‡"] = -calculateImageUploadPenalty(datas[17][platform].fps);
                negdata[platform]["ä¸Šä¼ è§†é¢‘"] = -calculateVideoUploadPenalty(datas[18][platform].fps);

            }
            //è®¡ç®—å¾—åˆ†æ•°æ®
            for (let platform in resdata) {
                for (let scene in negdata[platform]) {
                    resdata[platform][scene] = maxScores[scene] + negdata[platform][scene];
                }
            }
            console.log('è®¡ç®—ç»“æœ:', resdata);

            console.log('æ‰£åˆ†ç»“æœ:', negdata);
        }


        // å¯¼å‡ºæŒ‰é’®é€»è¾‘
        document.getElementById('export-btn').addEventListener('click', () => {
            setdatas();

            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            for (const [key, value] of Object.entries(datas)) {
                if (!value["æŠ–éŸ³"] || !value["å°çº¢ä¹¦"] || !value["å¿«æ‰‹"]) {
                    alert(`æµ‹è¯•åœºæ™¯ "${caseMap[key] || key}" çš„æ•°æ®ä¸å®Œæ•´å“ˆï¼Œäº²ï¼Œè¯·ç¡®è®¤ä¸€ä¸‹å“ˆã€‚`);
                    return;
                }
            }

            // ç¡®ä¿å·²è®¡ç®—å¾—åˆ†ä¸æ‰£åˆ†
            calculatePenalty();
            exportCSVAndJSON();
        });

        // æŠ½ç¦»å¯¼å‡ºé€»è¾‘ï¼Œä¾¿äºç»´æŠ¤
        function exportCSVAndJSON() {
            const now = new Date();
            const [year, month, day, hour, minute, second] = [
                now.getFullYear(),
                String(now.getMonth() + 1).padStart(2, '0'),
                String(now.getDate()).padStart(2, '0'),
                String(now.getHours()).padStart(2, '0'),
                String(now.getMinutes()).padStart(2, '0'),
                String(now.getSeconds()).padStart(2, '0')
            ];
            const fileName = `${year}${month}${day}${hour}${minute}${second}`;

            // âœ… UTF-8 BOM
            let csvContent = "\uFEFF";
            csvContent += `æµ‹è¯•ç»“æœè¡¨\n`;

            // ============ 1. åˆå¹¶å¾—åˆ†è¡¨ + æ‰£åˆ†è¡¨ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼‰===========
            csvContent += `æµ‹è¯•åœºæ™¯,æŠ–éŸ³å¾—åˆ†,å°çº¢ä¹¦å¾—åˆ†,å¿«æ‰‹å¾—åˆ†,max,æŠ–éŸ³æ‰£åˆ†,å°çº¢ä¹¦æ‰£åˆ†,å¿«æ‰‹æ‰£åˆ†\n`;

            // æ‰¾å‡ºæ‰€æœ‰ caseNameï¼ˆä»¥ resdata["æŠ–éŸ³"] çš„ key ä¸ºå‡†ï¼Œå‡è®¾å„å¹³å° case ä¸€è‡´ï¼‰
            const caseNames = Object.keys(resdata["æŠ–éŸ³"] || {});

            for (const caseName of caseNames) {
                const dyScore = (resdata["æŠ–éŸ³"] && resdata["æŠ–éŸ³"][caseName]) || 0;
                const xhsScore = (resdata["å°çº¢ä¹¦"] && resdata["å°çº¢ä¹¦"][caseName]) || 0;
                const ksScore = (resdata["å¿«æ‰‹"] && resdata["å¿«æ‰‹"][caseName]) || 0;
                const maxVal = maxScores[caseName] || '';

                const dyNeg = (negdata["æŠ–éŸ³"] && negdata["æŠ–éŸ³"][caseName]) || 0;
                const xhsNeg = (negdata["å°çº¢ä¹¦"] && negdata["å°çº¢ä¹¦"][caseName]) || 0;
                const ksNeg = (negdata["å¿«æ‰‹"] && negdata["å¿«æ‰‹"][caseName]) || 0;

                csvContent += `${caseName},${dyScore},${xhsScore},${ksScore},${maxVal},${dyNeg},${xhsNeg},${ksNeg}\n`;
            }
            // ============ 3. æ€»è®¡è¡Œ ============
            // ç»Ÿè®¡å„å¹³å°æ€»å¾—åˆ†
            let douyinTotal = 0, xiaohongshuTotal = 0, kuaishouTotal = 0, maxTotal = 0;
            for (const caseName of caseNames) {
                douyinTotal += resdata["æŠ–éŸ³"][caseName] || 0;
                xiaohongshuTotal += resdata["å°çº¢ä¹¦"][caseName] || 0;
                kuaishouTotal += resdata["å¿«æ‰‹"][caseName] || 0;
                maxTotal += maxScores[caseName] || 0;
            }

            csvContent += `æ€»è®¡,${douyinTotal},${xiaohongshuTotal},${kuaishouTotal},${maxTotal},,,\n`;
            // ============ 2. å¸§æ•°è¡¨ ============
            csvContent += `\nå¸§æ•°è¡¨\n`;
            csvContent += "æµ‹è¯•åœºæ™¯,æŠ–éŸ³å¸§æ•°,å°çº¢ä¹¦å¸§æ•°,å¿«æ‰‹å¸§æ•°\n";
            for (const [key, value] of Object.entries(datas)) {
                const caseName = caseMap[key] || key;
                const douyinFrames = value["æŠ–éŸ³"] ? value["æŠ–éŸ³"].fps : '';
                const xiaohongshuFrames = value["å°çº¢ä¹¦"] ? value["å°çº¢ä¹¦"].fps : '';
                const kuaishouFrames = value["å¿«æ‰‹"] ? value["å¿«æ‰‹"].fps : '';
                csvContent += `${caseName},${douyinFrames},${xiaohongshuFrames},${kuaishouFrames}\n`;
            }



            // ============ å¯¼å‡º CSV ============
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${fileName}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // ============ å¯¼å‡º JSON ============
            const jsonContent = JSON.stringify(datas, null, 2);
            const jsonBlob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            const jsonLink = document.createElement("a");
            jsonLink.href = jsonUrl;
            jsonLink.download = `${fileName}.json`;
            document.body.appendChild(jsonLink);
            jsonLink.click();
            document.body.removeChild(jsonLink);
            URL.revokeObjectURL(jsonUrl);
        }


        // è¾…åŠ©å‡½æ•°ï¼šå¸§è½¬æ—¶é—´å­—ç¬¦ä¸²
        function formatTime(timeStr) {
            if (!timeStr) return "00:00:00.000";
            const mm = timeStr.slice(0, 2);
            const ss = timeStr.slice(2, 4);
            let frames = timeStr.slice(4, 6);
            const hh = '00';
            frames = frames / 30 * 1000;
            frames = String(Math.round(frames)).padStart(3, '0').slice(0, 3);
            return `${hh}:${mm}:${ss}.${frames}`;
        }

        // å‰ªè¾‘ç›¸å…³é€»è¾‘ (API è°ƒç”¨)
        let clipSettings = {};
        function clipSingleVideo(caseName) {
            const sendData = datas[caseName];
            if (!sendData) return;

            const dy = sendData["æŠ–éŸ³"];
            const xhs = sendData["å°çº¢ä¹¦"];
            const ks = sendData["å¿«æ‰‹"];
            const outputName = outputPath + (caseMap[caseName] || caseName) + ".mp4";

            const payload = {
                input1: douyinPath, start1: formatTime(dy.start_time), end1: formatTime(dy.end_time),
                input2: xiaohongshuPath, start2: formatTime(xhs.start_time), end2: formatTime(xhs.end_time),
                input3: kuaishouPath, start3: formatTime(ks.start_time), end3: formatTime(ks.end_time),
                output: outputName, max_duration: null
            };
            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            // å‘é€ fetch è¯·æ±‚ (ç•¥ï¼Œä¿æŒåŸæ ·)
            // fetch("http://127.0.0.1:8000/merge", ... )

            console.log('å‡†å¤‡å‰ªè¾‘:', payload);
            fetch("http://127.0.0.1:8000/merge", {
                method: "POST",
                headers: myHeaders,
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (!response.ok) {
                        showTip(0,`âŒ ç¼–å· ${caseName} è§†é¢‘å‰ªè¾‘å¤±è´¥ï¼\nçŠ¶æ€ç : ${response.status}`);
                        throw new Error(`HTTP é”™è¯¯ï¼çŠ¶æ€: ${response.status}`);
                    }
                    return response.text();
                })
                .then(resultText => {
                    showTip(1,`âœ… ç¼–å· ${caseName} è§†é¢‘å‰ªè¾‘æˆåŠŸï¼`);
                    console.log(`âœ… ç¼–å· ${caseName} è§†é¢‘å‰ªè¾‘æˆåŠŸï¼\nè¿”å›ä¿¡æ¯: ${resultText}`);
                })
                .catch(error => {
                    showTip(0,`âŒ ç¼–å· ${caseName} è§†é¢‘å‰ªè¾‘å¤±è´¥ï¼\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                    alert(`âŒ ç¼–å· ${caseName} è§†é¢‘å‰ªè¾‘å¤±è´¥ï¼\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                });
        }

        document.getElementById('clip-single-btn').addEventListener('click', () => {
            const caseName = document.getElementById('case-select').value;
            clipSingleVideo(caseName);
        });


    </script>
</body>

</html>