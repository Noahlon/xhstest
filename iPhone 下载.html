<!DOCTYPE html> <html lang="zh-CN"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>æ–‡ä»¶ä¸‹è½½æœåŠ¡</title> <style> * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Helvetica Neue', Arial, sans-serif; } body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: #333; min-height: 100vh; padding: 20px; } .container { max-width: 800px; margin: 0 auto; background-color: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); overflow: hidden; } header { background: linear-gradient(to right, #4a00e0, #8e2de2); color: white; padding: 25px 20px; text-align: center; } h1 { font-size: 1.8rem; margin-bottom: 10px; } .subtitle { font-size: 1rem; opacity: 0.9; } .content { padding: 25px; } .file-list { margin-bottom: 25px; max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; } .file-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f0f0f0; } .file-item:last-child { border-bottom: none; } .file-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 8px; background-color: #f0f0f0; } .file-info { flex: 1; } .file-name { font-weight: 500; margin-bottom: 5px; } .file-size { font-size: 0.85rem; color: #777; } .download-btn { display: block; width: 100%; padding: 16px; background: linear-gradient(to right, #00b09b, #96c93d); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 20px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); } .download-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); } .download-btn:active { transform: translateY(0); } .download-btn:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; } .progress-container { margin-top: 20px; display: none; } .progress-bar { height: 10px; background-color: #e0e0e0; border-radius: 5px; overflow: hidden; margin-bottom: 10px; } .progress { height: 100%; background: linear-gradient(to right, #00b09b, #96c93d); width: 0%; transition: width 0.2s ease; } .progress-text { text-align: center; font-size: 0.9rem; color: #555; } .status { margin-top: 20px; padding: 15px; border-radius: 10px; text-align: center; display: none; } .status.success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; } .status.error { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; } .empty-state { text-align: center; padding: 30px; color: #777; } .empty-state i { font-size: 3rem; margin-bottom: 15px; color: #ccc; } .loading { text-align: center; padding: 20px; color: #555; } .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4a00e0; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; } @keyframes spin { to { transform: rotate(360deg); } } footer { text-align: center; padding: 20px; color: #777; font-size: 0.9rem; border-top: 1px solid #f0f0f0; } @media (max-width: 600px) { body { padding: 10px; } .container { border-radius: 15px; } header { padding: 20px 15px; } h1 { font-size: 1.5rem; } .content { padding: 20px 15px; } } </style> </head> <body> <div class="container"> <header> <h1>æ–‡ä»¶ä¸‹è½½æœåŠ¡</h1> <p class="subtitle">ä¸€é”®æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å›¾ç‰‡å’Œè§†é¢‘ï¼ˆiPhone/iPad å‹å¥½ï¼‰</p> </header>

    <div class="content">
        <div class="file-list" id="fileList">
            <div class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
            </div>
        </div>

        <button class="download-btn" id="downloadAllBtn" disabled>ä¸€é”®æ‰“åŒ…ä¸‹è½½</button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡ä¸‹è½½...</div>
        </div>

        <div class="status" id="statusMessage"></div>
    </div>

    <footer>
        <p>æ–‡ä»¶æœåŠ¡ &copy; 2023</p>
    </footer>
</div>

<!-- JSZip å’Œ FileSaverï¼ˆç”¨äº ZIP æ‰“åŒ…å’Œå…¼å®¹ iOS çš„ä¿å­˜ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileList = document.getElementById('fileList');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusMessage = document.getElementById('statusMessage');

        let files = [];

        const isIOS = () => {
            const ua = window.navigator.userAgent;
            const iOS = /iP(hone|od|ad)/.test(ua);
            const iPadOS13Plus = ua.includes('Mac') && 'ontouchend' in document;
            return iOS || iPadOS13Plus;
        };

        // è·å–æ–‡ä»¶åˆ—è¡¨
        fetch('./data/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('a');

                files = Array.from(links)
                    .map(link => {
                        const href = link.getAttribute('href');
                        const text = (link.textContent || '').trim();
                        if (href && !href.endsWith('/') && !href.startsWith('?')) {
                            return {
                                name: text || href.split('/').pop(),
                                url: './data/' + href,
                                type: getFileType(text || href)
                            };
                        }
                        return null;
                    })
                    .filter(file => file && (file.type === 'image' || file.type === 'video'));

                displayFiles(files);

                if (files.length > 0) {
                    downloadAllBtn.disabled = false;
                } else {
                    fileList.innerHTML = `
                        <div class="empty-state">
                            <i>ğŸ“</i>
                            <p>æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i>âŒ</i>
                        <p>æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</p>
                    </div>
                `;
            });

        function displayFiles(files) {
            if (files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ“</i>
                        <p>æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶</p>
                    </div>
                `;
                return;
            }
            fileList.innerHTML = '';

            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-icon">${getFileIcon(file.type)}</div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-size">${file.type === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘'}æ–‡ä»¶</div>
                    </div>
                `;

                // å•ä¸ªæ–‡ä»¶ç‚¹å‡»ï¼šåœ¨ iOS ä¸Šç›´æ¥æ‰“å¼€åŸæ–‡ä»¶ï¼ˆä¾¿äºâ€œä¿å­˜åˆ°æ–‡ä»¶â€ï¼‰
                fileItem.addEventListener('click', () => {
                    if (isIOS()) {
                        // iOS ä¸Šç›´æ¥æ‰“å¼€æºé“¾æ¥ï¼Œç”±ç³»ç»Ÿæ§åˆ¶ä¿å­˜
                        window.location.href = file.url;
                    } else {
                        // é iOSï¼šç›´æ¥æ‰“å¼€æ–°æ ‡ç­¾é¢„è§ˆ
                        window.open(file.url, '_blank');
                    }
                });

                fileList.appendChild(fileItem);
            });
        }

        function getFileType(filename) {
            const ext = (filename.split('.').pop() || '').toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const videoExts = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv'];
            if (imageExts.includes(ext)) return 'image';
            if (videoExts.includes(ext)) return 'video';
            return 'other';
        }

        function getFileIcon(type) {
            if (type === 'image') return 'ğŸ–¼ï¸';
            if (type === 'video') return 'ğŸ¥';
            return 'ğŸ“„';
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        // ä¸€é”®æ‰“åŒ…ä¸‹è½½ï¼ˆiOS å‹å¥½ï¼‰
        downloadAllBtn.addEventListener('click', async function() {
            if (!files.length) return;

            downloadAllBtn.disabled = true;
            showStatus('', null);
            progressContainer.style.display = 'block';
            setProgress(0, 'å‡†å¤‡ä¸‹è½½...');

            try {
                // 1. é€ä¸ªæ‹‰å–æ–‡ä»¶å¹¶åŠ å…¥ ZIPï¼Œè¿›åº¦ 0% -> 50%
                const zip = new JSZip();
                const safeName = makeUniqueNames(files.map(f => f.name));

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const name = safeName[i];
                    setProgress(Math.min(50, (i / Math.max(1, files.length)) * 50), `æ­£åœ¨è·å–æ–‡ä»¶ ${i + 1}/${files.length}ï¼š${name}`);
                    const resp = await fetch(file.url, { credentials: 'same-origin' });
                    if (!resp.ok) throw new Error(`è·å– ${name} å¤±è´¥ (${resp.status})`);
                    const blob = await resp.blob();
                    zip.file(name, blob);
                }

                // 2. ç”Ÿæˆ ZIPï¼Œè¿›åº¦ 50% -> 100%
                setProgress(50, 'æ­£åœ¨ç”Ÿæˆå‹ç¼©åŒ…...');
                const zipBlob = await zip.generateAsync(
                    { type: 'blob', compression: 'STORE' }, // å¯¹è§†é¢‘/å›¾ç‰‡æ— æŸå‹ç¼©æ›´å¿«
                    (metadata) => {
                        const p = 50 + (metadata.percent || 0) / 2;
                        setProgress(p, `æ­£åœ¨ç”Ÿæˆå‹ç¼©åŒ… ${Math.round(metadata.percent || 0)}%`);
                    }
                );

                const zipName = `files_${new Date().toISOString().replace(/[:T]/g, '-').slice(0, 19)}.zip`;
                await saveBlob(zipBlob, zipName);
                setProgress(100, 'æ‰“åŒ…å®Œæˆ');
                showStatus('æ‰€æœ‰æ–‡ä»¶å·²æ‰“åŒ…å¹¶ä¿å­˜ã€‚iPhone/iPad è¯·åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­é€‰æ‹©â€œä¿å­˜åˆ°æ–‡ä»¶â€ã€‚', 'success');

                // 3 ç§’åéšè—è¿›åº¦æ¡
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            } catch (err) {
                console.error(err);
                showStatus(err.message || 'ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                downloadAllBtn.disabled = false;
            }
        });

        function setProgress(percent, text) {
            const p = Math.max(0, Math.min(100, percent));
            progressBar.style.width = `${p}%`;
            progressText.textContent = text || `${Math.round(p)}%`;
        }

        function showStatus(message, type) {
            statusMessage.textContent = message || '';
            statusMessage.className = 'status' + (type ? ` ${type}` : '');
            statusMessage.style.display = message ? 'block' : 'none';
        }

        function makeUniqueNames(names) {
            // å»é‡åŒåï¼ša.jpg, a.jpg -> a.jpg, a(1).jpg
            const map = new Map();
            return names.map(n => {
                const base = n;
                if (!map.has(base)) {
                    map.set(base, 0);
                    return base;
                } else {
                    const idx = map.get(base) + 1;
                    map.set(base, idx);
                    const dot = base.lastIndexOf('.');
                    if (dot > 0) {
                        return base.slice(0, dot) + `(${idx})` + base.slice(dot);
                    } else {
                        return base + `(${idx})`;
                    }
                }
            });
        }

        async function saveBlob(blob, filename) {
            // ä¼˜å…ˆä½¿ç”¨ FileSaverï¼ˆå…¼å®¹ iOSï¼‰
            if (typeof saveAs === 'function') {
                try {
                    saveAs(blob, filename);
                    return;
                } catch (e) {
                    console.warn('FileSaver saveAs å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ', e);
                }
            }
            const blobUrl = URL.createObjectURL(blob);
            if (isIOS()) {
                // iOSï¼šç›´æ¥è·³è½¬åˆ° blob URLï¼Œç”±ç³»ç»Ÿå¤„ç†ä¿å­˜ï¼ˆåœ¨â€œå…±äº«/ä¿å­˜åˆ°æ–‡ä»¶â€é‡Œï¼‰
                window.location.href = blobUrl;
                setTimeout(() => URL.revokeObjectURL(blobUrl), 60 * 1000);
            } else {
                // å…¶ä»–æµè§ˆå™¨ï¼ša[download]
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
            }
        }
    });
</script>
</body> </html>